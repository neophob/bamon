
const CpuBoard = require('../lib/boards/cpu-board');
const decode = require('./rle.js');

const W = 512*8;
const H = 512*8;

let cpuBoard;
let romObject;
let uistate;

const SYSTEM_ROM_SIZE_BYTES = 32 * 1024;
const diagrams = [];

//The colour palette of 1959 - Le Corbusier's Architectural Polychromy
const allC = ['#8A310F', '#C58BA2', '#653626', '#152328', '#B5B32B', '#6E9D7D', '#9CA0A2', '#585552', '#667BB5', '#DEB274', '#742E40', '#A2C2E9', '#A8AAAC', '#F1D3A5', '#3D3C38', '#D68362', '#2A3C71', '#5B6068', '#EDC433', '#232F34'];

//the rom
const rleB64File = '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';

const rleUint8Array = new Uint8Array(atob(rleB64File).split('').map(
    (char)=>char.charCodeAt(0)
));
const u06Rom = decode(rleUint8Array);

class DG {
  constructor(n = 64, name) {
    this.n = n;
    this.name = name;
    this.values = new Array(n);//.fill(0);
    this.pos = 0;
    this.max = 0;
    this.interesting = 0;
  }

  valueAsString() {
    return this.values.join('');
  }

  get8bitNormalizedValues() {
    const mavVal = this.max > 0 ? this.max : 1;
    return this.values.map((v) => parseInt(0.5 + v / mavVal * 255));
  }

  // add value to diagram
  add(value) {
    this.values[this.pos] = value;
    this.pos = (this.pos + 1) % this.n;
    this.max = value > this.max ? value : this.max;

    // calculate how interesting (changes) a diagram is
    let interesting = 0;
    this.avg = 0;
    for (let nn = 0; nn < this.values.length - 1; nn++) {
      const aa = this.values[nn] - this.values[nn + 1];
      const bb = aa < 0 ? 0-aa : aa;
      interesting += (bb > 0) ? 1 : 0;

      if (this.max > 0)
        this.avg += this.values[nn]/this.max;
    }
    this.interesting = interesting;
  }

}
function diag(name, n) {
  if (!diagrams[name]) {
    diagrams[name] = new DG(n, name);
  }
  return diagrams[name];
}

function getRandomInt(max) {
  return (fxrand()*max)|0;
}


// -- ### CONFIG START --

let cpuSteps = 500 + getRandomInt(10000);
let cpuStepsInitialRound = 5000 + getRandomInt(30000);
// initial rounds and viible rounds need to be at lest 96 like the diag size
let initialRounds = 92 + getRandomInt(600); //600);

window.$fxhashFeatures = {
  "CPU Steps": cpuSteps,
  "Initial Rounds": initialRounds,
}
console.table(window.$fxhashFeatures);

console.table('INIT', {cpuSteps,initialRounds,cpuStepsInitialRound});
// -- ### CONFIG END --


function rndr() {

  const interestingMEM = [];
  const minimalInterest = 12;

  for (let rr = 0; rr < initialRounds; rr++) {
    cpuBoard.E(cpuSteps, 16);
    uistate = cpuBoard.S();
  
    ['scanline','activepage','tk','vidOutPointer'].forEach((reg, ofs) => {
      const dd = diag('DMD'+(ofs+1));
      dd.add(uistate.dmd[reg]);
    });
  
    ['X','Y','S','U','CC','A','DP','B','PC','irq', 'mIRQ'].forEach((reg, ofs) => {
      const dd = diag('CPU'+(ofs+1));
      dd.add(uistate.cpu[reg]);
    });
  
    uistate.ram.forEach((value,ofs) => {
      //if (ofs <  10) console.info(ofs,value)
      const dd = diag('MEM'+ofs, 64);
      dd.add(value);
    });

    ['irqEna','wadogTicks','zcf','diagLed','activeRomBnk','lmpCol','lmpRow','ticksZC','inpCol', 'irqCountGI'].forEach((reg, ofs) => {
      const dd = diag('WPC'+(ofs+1));
      dd.add(uistate.wpc[reg]);
    });    
  }

// extract interesting values
['scanline','activepage','tk','vidOutPointer'].forEach((reg, ofs) => {
  const dd = diag('DMD'+(ofs+1));
  if (dd.interesting > minimalInterest) {
    interestingMEM.push(dd);
  } 
});

['X','Y','S','U','CC','A','DP','B','PC','irq', 'mIRQ'].forEach((reg, ofs) => {
  const dd = diag('CPU'+(ofs+1));
  if (dd.interesting > minimalInterest) {
    interestingMEM.push(dd);
  } 
});

let uniqueMemState = [];
uistate.ram.forEach((value,ofs) => {
  //if (ofs <  10) console.info(ofs,value)
  const dd = diag('MEM'+ofs, 64);
  if (dd.interesting > minimalInterest) {
    const ddStr = dd.valueAsString();
    const containsValue = uniqueMemState.includes(ddStr);

    if (!containsValue) {
      interestingMEM.push(dd);
      if (!containsValue) {
        uniqueMemState.push(ddStr);
      }  
    }
  } 

});
uniqueMemState = [];

['irqEna','wadogTicks','zcf','diagLed','activeRomBnk','lmpCol','lmpRow','ticksZC','inpCol', 'irqCountGI'].forEach((reg, ofs) => {
  const dd = diag('WPC'+(ofs+1));
  dd.add(uistate.wpc[reg]);
  if (dd.interesting > minimalInterest) {
    interestingMEM.push(dd);
  }
});  

  const src = interestingMEM
    .filter((dd) => dd.interesting > 1 && (new Set(dd.values).size) > 2)
    .sort((a, b) => {
      if (a.interesting < b.interesting) return -1;
      if (a.interesting > b.interesting) return 1;
      if (a.max < b.max) return -1;
      if (a.max > b.max) return 1;
      return 0;
    }).reverse();

  // TODO validate lowest value
  if (src.length < 12) {
    console.log('retry:', src.length)
    rndr();
  }

  c.fillStyle = 'black';
  c.fillRect(0, 0, W, H);

  let rawData = [];
  for (let i = 0; i<src.length; i++) {
    rawData = rawData.concat(src[i].get8bitNormalizedValues());
  }
  const elementsPerEntry = 10;
  const dataForElements = rawData.length / elementsPerEntry
  console.table({elementsPerEntry, dataForElements});

  let x = 0;
  let y = 0;
  for (let i = 0; i<dataForElements; i++) {
    const ofs = i * elementsPerEntry;
    const col = rawData[ofs+0];
    const border = rawData[ofs+1] > 128;
    const style = rawData[ofs+2];
    const xSize = rawData[ofs+3];
    const ySize = rawData[ofs+4];
    const xMul = rawData[ofs+5] >> 2;
    const yMul = rawData[ofs+6] >> 2;
    const enableMulX = rawData[ofs+7] > 200;
    const strokeWidth = 8*(rawData[ofs+8] >> 3);
    const scol = rawData[ofs+9];
    const enableMulY = rawData[ofs+10] > 200;


    console.log(
      i, '#',
      col,border,style, '#',
      xSize,
      ySize,
      xMul,
      yMul,
      enableMulX,enableMulY,strokeWidth
    )
  
    const xpos = x*250;
    const ypos = y*250;
    const xWidth = xSize * (enableMulX ? xMul : 1);
    const yHeight = ySize * (enableMulY ? yMul : 1);
    if (border) {
      c.strokeWidth = strokeWidth;
      c.strokeStyle = allC[scol%allC.length];
      c.strokeRect(xpos, ypos, xWidth, yHeight);      
    }
    //c.fillStyle = allC[col%allC.length];
    c.fillStyle = `rgb(${col}, ${col}, ${col})`;
    c.fillRect(xpos, ypos, xWidth, yHeight);
  
    if (++x > 16) {
      x = 0;
      y++;
    }
  }

  return    requestAnimationFrame(rndr);

  const ms = uistate.cpu.tick / 2000
  console.info('Emulator runtime: ' + ms + 'ms');

  fxpreview();
  console.table('DONE');  
}

window.onload = () => {
  const a = document.getElementById("c");
  a.width = W;
  a.height = H;
  c = a.getContext("2d");

  console.info('# WPCEMU')
  
  romObject = {
    systemRom: u06Rom.subarray(-SYSTEM_ROM_SIZE_BYTES),
    gameRom: u06Rom,
  };

  cpuBoard = CpuBoard(romObject);
  rndr();
};
